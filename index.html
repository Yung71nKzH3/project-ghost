<!DOCTYPE html>
<html>
<head>
  <style>
    /* 1. ROOT SETUP */
    html, body { 
      margin: 0; padding: 0; 
      width: 100%; height: 100%; 
      overflow: hidden; 
      font-family: 'Consolas', 'Courier New', monospace; 
      background: transparent; 
    }

    /* 2. UI LAYER (Floating on top) */
    #ui-layer {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: flex; justify-content: center; align-items: center;
      z-index: 9999;
      pointer-events: none; /* Default: Click-through empty space */
      transition: opacity 0.2s, visibility 0.2s;
    }

    #command-box {
      background: rgba(0, 0, 0, 0.95);
      border: 2px solid #00ff00;
      padding: 20px;
      width: 650px;
      display: flex; flex-direction: column; gap: 15px;
      box-shadow: 0 0 25px rgba(0, 255, 0, 0.2);
      pointer-events: auto; /* Catch clicks on the box */
      border-radius: 6px;
    }

    #status {
      position: fixed; bottom: 15px; right: 15px;
      color: #00ff00; background: rgba(0,0,0,0.7);
      padding: 5px 10px; border-radius: 4px;
      font-weight: bold; pointer-events: none;
      z-index: 10000;
      font-size: 12px;
      text-transform: uppercase;
      border: 1px solid #00ff00;
      transition: opacity 0.2s;
    }

    input[type="text"] {
      background: #0f0f0f; color: #00ff00;
      border: 1px solid #333; padding: 12px;
      font-size: 16px; font-family: inherit; outline: none;
    }
    
    .controls {
      display: flex; gap: 10px; align-items: center;
      color: #00ff00; font-size: 12px;
    }

    input[type=range] { flex-grow: 1; accent-color: #00ff00; cursor: pointer; }

    button {
      background: #002200; color: #00ff00;
      border: 1px solid #00ff00; padding: 8px 12px;
      cursor: pointer; font-weight: bold; font-family: inherit;
      transition: all 0.2s; min-width: 80px;
    }
    button:hover { background: #00ff00; color: black; }
    
    /* Projector Button Styling */
    #projectorBtn { display: none; border-color: #ffcc00; color: #ffcc00; }
    #projectorBtn.active { background: #ffcc00; color: black; box-shadow: 0 0 15px #ffcc00; }

    /* 3. VIEW CONTAINER (The Content) */
    #view-container { 
      position: absolute; 
      top: 0; left: 0;
      width: 100vw; 
      height: 100vh; 
      z-index: 1; 
      overflow: hidden;
    }
    
    /* FIX: Force webview to use Viewport Width/Height so it never shrinks */
    webview { 
      position: absolute;
      top: 0; left: 0;
      width: 100vw; 
      height: 100vh; 
      border: none;
      z-index: 2; /* Sits above video by default */
    }
    
    /* The Projector Screen */
    video { 
      position: absolute;
      top: 0; left: 0;
      width: 100vw; 
      height: 100vh; 
      object-fit: fill; /* Stretch to fill */
      pointer-events: none; 
      z-index: 3; /* Sits above webview when active */
    }

    /* Utility to hide things completely without breaking layout */
    .hidden { 
      opacity: 0; 
      visibility: hidden; 
      pointer-events: none !important; 
    }
    
    .fully-hidden { opacity: 0 !important; pointer-events: none !important; }
  </style>
</head>
<body>

  <div id="ui-layer" class="hidden">
    <div id="command-box">
      <div style="text-align: center; color: #00ff00; letter-spacing: 3px; font-size: 14px;">
        GHOST://PROJECTOR_CORE
      </div>
      
      <input type="text" id="urlInput" placeholder="ENTER TARGET URL..." />
      
      <div class="controls">
        <span>OPACITY</span>
        <input type="range" id="opacitySlider" min="0.1" max="1" step="0.05" value="1">
        
        <button onclick="navigate()">GO</button>
        <button id="glassBtn" onclick="toggleGlassMode()">GLASS FX</button>
        <button id="projectorBtn" onclick="startProjector()">START PROJECTOR</button>
      </div>
      <div style="font-size: 10px; color: #666; text-align: center;">
        [Shift+Z: Stealth] [Shift+X: Menu] [Shift+H: Hide All]
      </div>
    </div>
  </div>

  <div id="status">STATUS: GHOST</div>

  <div id="view-container">
    <webview id="view" src="about:blank" allowpopups plugins></webview>
    <!-- Video starts hidden via class, not display:none -->
    <video id="projector" class="hidden" autoplay muted></video>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    
    const uiLayer = document.getElementById('ui-layer');
    const status = document.getElementById('status');
    const view = document.getElementById('view');
    const video = document.getElementById('projector');
    const input = document.getElementById('urlInput');
    const glassBtn = document.getElementById('glassBtn');
    const projBtn = document.getElementById('projectorBtn');
    const slider = document.getElementById('opacitySlider');

    let currentMode = 'GHOST';
    let glassKey = null;

    // --- NAVIGATION ---
    function navigate() {
      let url = input.value;
      if (!url) return;
      if (!url.startsWith('http')) url = 'https://' + url;

      const restricted = ['netflix.com', 'primevideo.com', 'amazon.co.uk/video', 'disneyplus.com'];
      const isRestricted = restricted.some(site => url.includes(site));

      if (isRestricted) {
        // 1. Launch External Chrome
        ipcRenderer.send('launch-external', url);
        status.innerText = "STATUS: EXTERNAL APP LAUNCHED. CLICK 'START PROJECTOR'";
        
        // 2. Prep UI for Projector Mode
        projBtn.style.display = 'block';
        projBtn.classList.remove('active');
        
        // Switch Layers using Classes (Keeps layout intact)
        view.classList.add('hidden');
        video.classList.remove('hidden');
        
        setMode('COMMAND'); 
      } else {
        // Normal Mode
        view.src = url;
        
        // Switch Layers
        view.classList.remove('hidden');
        video.classList.add('hidden');
        
        projBtn.style.display = 'none';
        setMode('GHOST');
      }
    }

    // --- THE PROJECTOR LOGIC ---
    async function startProjector() {
      status.innerText = "SCANNING FOR WINDOWS...";
      
      const sources = await ipcRenderer.invoke('get-sources');
      
      const target = sources.find(s => 
        s.name.toLowerCase().includes("netflix") || 
        s.name.toLowerCase().includes("prime video") || 
        s.name.toLowerCase().includes("google chrome")
      );

      if (!target) {
        status.innerText = "ERROR: SOURCE WINDOW NOT FOUND. PLAY VIDEO FIRST.";
        return;
      }

      status.innerText = `PROJECTING: ${target.name}`;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          audio: false, 
          video: {
            mandatory: {
              chromeMediaSource: 'desktop',
              chromeMediaSourceId: target.id,
              minWidth: 0,
              maxWidth: 3840, 
              minHeight: 0,
              maxHeight: 2160
            }
          }
        });
        
        video.srcObject = stream;
        video.play();
        projBtn.classList.add('active');
        
        setMode('GHOST');
        
      } catch (e) {
        console.error(e);
        status.innerText = "CAPTURE ERROR: " + e.message;
      }
    }

    // --- MODE SWITCHING ---
    function setMode(mode) {
      currentMode = mode;
      
      if (mode === 'GHOST') {
        uiLayer.classList.add('hidden');
        status.style.opacity = '0.5';
        ipcRenderer.send('set-ignore-mouse', { ignore: true, forward: false });
      } else if (mode === 'STEALTH') {
        uiLayer.classList.add('hidden');
        status.innerText = "STATUS: STEALTH (MOUSE ACTIVE)";
        status.style.opacity = '1';
        ipcRenderer.send('set-ignore-mouse', { ignore: false });
      } else if (mode === 'COMMAND') {
        uiLayer.classList.remove('hidden');
        status.innerText = "STATUS: COMMAND CENTER";
        status.style.opacity = '1';
        ipcRenderer.send('set-ignore-mouse', { ignore: false });
        input.focus();
        input.select();
      } else if (mode === 'HIDDEN') {
        uiLayer.classList.add('hidden');
        status.style.opacity = '0';
        // Hide the container to make it truly invisible
        document.getElementById('view-container').classList.add('hidden');
        ipcRenderer.send('set-ignore-mouse', { ignore: true, forward: false });
      }
      
      // Restore visibility if leaving HIDDEN mode
      if (mode !== 'HIDDEN') {
        document.getElementById('view-container').classList.remove('hidden');
      }
    }

    ipcRenderer.on('toggle-stealth', () => setMode(currentMode === 'GHOST' ? 'STEALTH' : 'GHOST'));
    ipcRenderer.on('toggle-command', () => setMode(currentMode === 'GHOST' ? 'COMMAND' : 'GHOST'));
    ipcRenderer.on('toggle-hide', () => currentMode === 'HIDDEN' ? setMode('GHOST') : setMode('HIDDEN'));

    // --- UTILS ---
    async function toggleGlassMode() {
      // Glass FX only works on the Webview, not the Projector video
      if (view.classList.contains('hidden')) return; 
      
      if (glassKey) {
        await view.removeInsertedCSS(glassKey);
        glassKey = null;
        glassBtn.classList.remove('active');
      } else {
        const css = `html, body, #content, #page-manager, ytd-app { background: transparent !important; }`;
        glassKey = await view.insertCSS(css);
        glassBtn.classList.add('active');
      }
    }

    function toggleCinemaMode() {
      if (view.classList.contains('hidden')) {
         // Projector Mode: Cycle Fit Types
         const current = getComputedStyle(video).objectFit;
         if (current === 'fill') video.style.objectFit = 'contain';
         else if (current === 'contain') video.style.objectFit = 'cover';
         else video.style.objectFit = 'fill';
         
         status.innerText = `VIDEO MODE: ${video.style.objectFit.toUpperCase()}`;
         status.style.opacity = 1;
         setTimeout(() => status.style.opacity = 0.5, 2000);
      } else {
        // Webview Mode: Inject Fullscreen CSS
        view.executeJavaScript(`(function(){const v=document.querySelector('video');if(!v)return;v.style.cssText=v.style.position==='fixed'?'':'position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:black;';})();`);
      }
    }

    slider.addEventListener('input', (e) => {
      document.getElementById('view-container').style.opacity = e.target.value;
    });

    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') navigate(); });

    setMode('GHOST');
  </script>
</body>
</html>